# Vibe 部署工具需求文档

## 1. 项目概述

### 1.1 目标
开发一个基于 Go 1.24.5 的 Web 可视化部署工具，实现定时任务、代码拉取、自动化部署、手动触发部署、shell 脚本管理、二进制打包、rootless 运行、SSH 集成配置、可视化流水线和权限管理等功能。

### 1.2 核心价值
- **自动化**：减少手动操作，提高部署效率
- **可视化**：直观展示部署流程和状态
- **灵活性**：支持定时任务和手动触发两种模式
- **安全性**：实现 rootless 运行和权限管理
- **可维护性**：集中管理部署脚本和配置

## 2. 功能需求

### 2.1 核心功能
1. **Web 可视化界面**
   - 仪表盘展示系统状态和部署历史
   - 项目管理界面
   - 部署流水线可视化
   - 任务调度管理界面
   - 权限管理界面

2. **代码拉取**
   - 仅支持 Git 版本控制系统
   - 支持分支、标签选择
   - 支持 SSH 和 HTTPS 协议
   - 代码拉取状态监控

3. **自动化部署**
   - 支持定时任务调度（基于 Cron 表达式）
   - 支持 Webhook 触发
   - 部署流程自定义配置
   - 部署日志实时查看
   - 部署结果通知（邮件、IM 等）

4. **手动触发部署**
   - 一键部署功能
   - 部署参数自定义
   - 部署过程可视化
   - 部署中断和回滚功能

5. **Shell 脚本管理**
   - 脚本版本控制
   - 脚本编辑和测试功能
   - 脚本执行权限控制
   - 常用脚本模板

6. **二进制打包**
   - 支持多种编程语言项目打包
   - 打包参数配置
   - 打包结果管理
   - 版本号自动生成
   - 项目本身支持打包成单个二进制文件，便于部署和分发

7. **Rootless 运行**
   - 非 root 用户运行模式
   - 权限隔离
   - 安全沙箱机制

8. **SSH 集成配置**
   - SSH 密钥管理
   - 远程服务器连接配置
   - 连接测试功能
   - 密钥自动生成和分发

9. **可视化流水线**
   - 流水线定义和编辑
   - 流水线执行状态实时展示
   - 流水线阶段和任务管理
   - 流水线历史记录

10. **权限管理**
    - 用户角色定义（管理员、开发者、查看者等）
    - 项目级权限控制
    - 操作审计日志
    - 用户认证和授权

## 3. 技术规范

### 3.1 后端技术栈
- **编程语言**：Go 1.24.5
- **Web 框架**：Gin 或 Echo
- **CLI 框架**：cobra
- **配置管理**：viper
- **数据库**：PostgreSQL 或 SQLite（存储配置和元数据，可选）
- **缓存**：Redis（存储会话和临时数据）
- **任务调度**：自研调度器或使用 robfig/cron
- **SSH 库**：golang.org/x/crypto/ssh
- **Git 库**：go-git/go-git
- **API 文档**：Swagger/OpenAPI

### 3.2 前端技术栈
- **框架**：React
- **组件库**：Shadcn
- **构建工具**：Vite
- **状态管理**：Redux 或 Context API
- **路由**：React Router
- **UI 设计系统**：Tailwind CSS
- **图表库**：Echarts 或 Chart.js

### 3.3 系统架构
```
+-------------------+       +-------------------+       +-------------------+
|    前端应用       |<----->|    后端 API       |<----->|    部署代理       |
|  (React+Shadcn)   |       |    (Go 1.24.5)    |       |    (Go 1.24.5)    |
+-------------------+       +-------------------+       +-------------------+
                                      |                           |
                                      v                           v
                             +-------------------+       +-------------------+
                             |    数据库         |       |    目标服务器     |
                             |  (PostgreSQL)     |       |                   |
                             +-------------------+       +-------------------+
                                      |
                                      v
                             +-------------------+
                             |    缓存           |
                             |  (Redis)          |
                             +-------------------+
```

### 3.3 配置管理
- 支持 YAML 配置文件
- 支持命令行参数启动服务
- 启动参数包括：
  - 指定端口
  - 配置文件路径
  - 数据库类型（PostgreSQL 或 SQLite）
  - 数据库连接信息
  - 日志级别

### 3.4 安全规范
- 所有密码和密钥必须加密存储
- API 通信必须使用 HTTPS
- 实现基于角色的访问控制（RBAC）
- 所有用户操作必须记录审计日志
- 最小权限原则
- 防 SQL 注入、XSS 等常见安全问题

### 3.5 性能要求
- API 响应时间 < 1 秒
- 页面加载时间 < 3 秒
- 支持同时处理 100+ 部署任务
- 支持水平扩展

## 4. 实施计划

### 4.1 阶段划分
- **Phase 1**：基础架构搭建（2 周）
  - 后端 API 框架搭建
  - 前端项目初始化
  - 数据库设计和实现

- **Phase 2**：核心功能开发（4 周）
  - 代码拉取功能
  - 部署流程实现
  - Web 界面开发
  - 任务调度系统

- **Phase 3**：高级功能开发（3 周）
  - SSH 集成
  - 二进制打包
  - Rootless 运行模式
  - 权限管理

- **Phase 4**：测试和优化（2 周）
  - 功能测试
  - 性能优化
  - 安全测试
  - 文档完善

### 4.2 交付物
1. 完整的后端代码库
2. 完整的前端代码库
3. 数据库设计文档
4. API 文档
5. 部署指南
6. 用户手册
7. 测试报告

## 5. 成功指标

### 5.1 功能指标
- 部署成功率 ≥ 99%
- 任务调度准确率 100%
- 权限控制准确率 100%
- 系统可用性 ≥ 99.9%

### 5.2 性能指标
- API 响应时间 < 1 秒
- 页面加载时间 < 3 秒
- 支持 100+ 并发部署任务

### 5.3 用户体验指标
- 用户满意度 ≥ 4.5/5.0
- 培训时间 ≤ 2 小时
- 问题解决时间 ≤ 30 分钟

## 6. 风险评估

### 6.1 技术风险
- Go 1.24.5 兼容性问题
- SSH 集成复杂性
- Rootless 运行模式实现难度
- 大规模并发部署性能问题

### 6.2 缓解措施
- 提前进行技术验证
- 采用模块化设计，降低耦合
- 性能测试和优化
- 完善的错误处理和日志系统

## 7. 维护策略

### 7.1 版本管理
- 语义化版本控制
- 变更日志记录
- 向后兼容性保证

### 7.2 持续改进
- 用户反馈收集
- 性能监控分析
- 定期安全审计
- 功能迭代计划